# ------------------------------------------------------------
# Workflow Name : CI
# Trigger       : pull_request to master
# Purpose       :
#   - 変更に対して Lint / UnitTest を実行
# ------------------------------------------------------------
name: CI

on:
  pull_request:
    branches:
      - master

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: 1

jobs:

  Lint:
    name: Lint
    runs-on: windows-latest
    strategy:
      matrix:
        dotnet-version: ["8.0.x"]
    steps:
      - uses: actions/checkout@v5

      - name: Caching Nuget packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
          key: nuget-${{ runner.os }}-dotnet-${{ matrix.dotnet-version }}-${{ hashFiles('**/packages.lock.json','**/Directory.Packages.props','global.json','NuGet.config') }}
          restore-keys: |
            nuget-${{ runner.os }}-dotnet-${{ matrix.dotnet-version }}-
            nuget-${{ runner.os }}-

      - name: Cache HTTP v3 cache (Windows)
        uses: actions/cache@v4
        with:
          path: |
            $LOCALAPPDATA\NuGet\v3-cache
          key: nugethttp-${{ runner.os }}-dotnet-${{ matrix.dotnet-version }}-${{ hashFiles('**/packages.lock.json', '**/Directory.Packages.props', 'global.json', 'NuGet.config') }}
          restore-keys: |
            nugethttp-${{ runner.os }}-dotnet-${{ matrix.dotnet-version }}-
            nugethttp-${{ runner.os }}-

      - name: Setup .NET ${{ matrix.dotnet-version }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: Restore
        shell: pwsh
        run: dotnet restore --locked-mode

      - name: Formatting
        shell: pwsh
        run: >
          dotnet format
          --no-restore
          --verify-no-changes
          --verbosity normal

  Unit:
    name: Unit Tests
    runs-on: windows-latest
    strategy:
      matrix:
        dotnet-version: ["8.0.x"]
        test-project:
          - "DcsTranslateTool.Core.Tests/DcsTranslateTool.Core.Tests.csproj"
          - "DcsTranslateTool.Core.Tests/DcsTranslateTool.Win.Tests.csproj"
    steps:
      - uses: actions/checkout@v5

      - name: Caching Nuget packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/.nuget/packages
            ~/.nuget/packages
          key: nuget-${{ runner.os }}-dotnet-${{ matrix.dotnet-version }}-${{ hashFiles('**/packages.lock.json','**/Directory.Packages.props','global.json','NuGet.config') }}
          restore-keys: |
            nuget-${{ runner.os }}-dotnet-${{ matrix.dotnet-version }}-
            nuget-${{ runner.os }}-

      - name: Cache HTTP v3 cache (Windows)
        uses: actions/cache@v4
        with:
          path: |
            $LOCALAPPDATA\NuGet\v3-cache
          key: nugethttp-${{ runner.os }}-dotnet-${{ matrix.dotnet-version }}-${{ hashFiles('**/packages.lock.json', '**/Directory.Packages.props', 'global.json', 'NuGet.config') }}
          restore-keys: |
            nugethttp-${{ runner.os }}-dotnet-${{ matrix.dotnet-version }}-
            nugethttp-${{ runner.os }}-

      - name: Setup .NET ${{ matrix.dotnet-version }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: Restore
        shell: pwsh
        run: dotnet restore --locked-mode

      - name: Build
        shell: pwsh
        run: >
          dotnet build ${{ matrix.test-project }}
          -c Release
          --no-restore
          --nologo

      - name: Unit Tests
        shell: pwsh
        run: >
          dotnet test
          -c Release
          --no-build
          --no-restore

  # TODO: write Integration tests job
  # Integration:
  #   needs: [call-restore]
  #   runs-on: windows-latest
  #   steps:
  #     - name: x
  # TODO: write e2e tests job
  # E2E:
  #   needs: [call-restore]
  #   runs-on: windows-latest
  #   steps:
  #     - name: x
